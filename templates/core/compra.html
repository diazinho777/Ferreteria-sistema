{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="sistemaCompras()">
    
    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-8 border-red-700 pl-4">
        Registrar Compra (Entrada)
    </h2>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-red-700">
        <label class="block text-sm font-bold mb-2 text-gray-800">Seleccionar Proveedor</label>
        <div class="relative">
            <select x-model="idProveedor" class="w-full p-3 border-2 border-gray-300 rounded focus:border-red-600 focus:outline-none bg-white">
                <option value="">-- Seleccione --</option>
                {% for p in proveedores %}
                    <option value="{{ p.id_proveedor }}">{{ p.empresa }} ({{ p.ruc }})</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex gap-4 mb-4 items-end">
            <div class="flex-grow">
                <label class="block text-xs font-bold mb-1 text-gray-700">ID Producto</label>
                <input type="number" x-model="idInput" @keydown.enter="buscarProducto()" 
                       placeholder="ID..." 
                       class="w-full p-2 border-2 border-gray-300 rounded focus:border-red-600 focus:outline-none">
            </div>
            <div class="w-24">
                <label class="block text-xs font-bold mb-1 text-gray-700">Costo Unit.</label>
                <input type="number" x-model="costoInput" 
                       class="w-full p-2 border-2 border-gray-300 rounded focus:border-red-600 focus:outline-none" 
                       placeholder="Auto">
            </div>
            <div class="w-20">
                <label class="block text-xs font-bold mb-1 text-gray-700">Cant.</label>
                <input type="number" x-model="cantidadInput" 
                       class="w-full p-2 border-2 border-gray-300 rounded focus:border-red-600 focus:outline-none text-center" 
                       min="1">
            </div>
            <button @click="buscarProducto()" class="bg-gray-900 text-white px-6 py-2 rounded font-bold hover:bg-gray-800 transition">
                AGREGAR
            </button>
        </div>
        
        <div x-show="mensajeError" class="bg-red-100 text-red-700 p-2 rounded mb-3 text-sm font-bold" x-text="mensajeError" style="display: none;"></div>

        <table class="w-full border-collapse">
            <thead class="bg-gray-900 text-white">
                <tr>
                    <th class="p-3 text-left text-sm uppercase">Producto</th>
                    <th class="p-3 text-right text-sm uppercase">Costo</th>
                    <th class="p-3 text-center text-sm uppercase">Cant.</th>
                    <th class="p-3 text-right text-sm uppercase">Subtotal</th>
                    <th class="p-3"></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <template x-for="(item, index) in carrito" :key="index">
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-800" x-text="item.nombre"></td>
                        <td class="p-3 text-right text-gray-600">C$ <span x-text="item.precio"></span></td>
                        <td class="p-3 text-center font-bold" x-text="item.cantidad"></td>
                        <td class="p-3 text-right font-bold text-gray-900">C$ <span x-text="(item.precio * item.cantidad).toFixed(2)"></span></td>
                        <td class="p-3 text-center">
                            <button @click="carrito.splice(index, 1)" class="text-red-500 hover:text-red-700 font-bold px-2">✕</button>
                        </td>
                    </tr>
                </template>
                <tr x-show="carrito.length === 0">
                    <td colspan="5" class="p-8 text-center text-gray-400 italic">No hay productos en la lista de entrada.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="flex justify-end items-center gap-6 bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <div class="text-right">
            <span class="block text-sm font-bold text-gray-500 uppercase">Total Compra</span>
            <div class="text-4xl font-black text-red-700">C$ <span x-text="totalCompra.toFixed(2)"></span></div>
        </div>
        <button @click="guardarCompra()" :disabled="carrito.length === 0 || !idProveedor" 
                class="bg-red-700 text-white px-8 py-4 rounded font-bold hover:bg-red-800 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg transition transform hover:scale-105">
            FINALIZAR ENTRADA
        </button>
    </div>
</div>

<script>
    function sistemaCompras() {
        return {
            idProveedor: '',
            idInput: '',
            cantidadInput: 1,
            costoInput: '', 
            carrito: [],
            mensajeError: '',

            get totalCompra() { return this.carrito.reduce((sum, i) => sum + (i.precio * i.cantidad), 0); },

            init() {
                this.$nextTick(() => {
                    // Enfocar si existe el input (por si acaso)
                    const input = document.querySelector('input[type="number"]');
                    if(input) input.focus();
                });
            },

            async buscarProducto() {
                if (!this.idInput) return;
                this.mensajeError = '';
                
                try {
                    const res = await fetch(`/api/producto/${this.idInput}/`);
                    const data = await res.json();
                    
                    if (data.encontrado) {
                        let costoFinal = this.costoInput ? parseFloat(this.costoInput) : data.precio; 
                        
                        this.carrito.push({
                            id: data.id,
                            nombre: data.nombre,
                            precio: costoFinal,
                            cantidad: parseInt(this.cantidadInput)
                        });
                        this.idInput = ''; this.cantidadInput = 1; this.costoInput = '';
                    } else {
                        this.mensajeError = 'Producto no encontrado';
                    }
                } catch (error) {
                    this.mensajeError = 'Error de conexión';
                }
            },

            async guardarCompra() {
                if (!confirm('¿Registrar entrada de mercadería y actualizar stock?')) return;
                
                try {
                    const res = await fetch('/api/guardar-compra/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: this.carrito, total: this.totalCompra, id_proveedor: this.idProveedor })
                    });
                    const data = await res.json();
                    if (data.status === 'ok') {
                        alert('✅ Compra registrada con éxito. El stock ha sido actualizado.');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.mensaje);
                    }
                } catch (error) {
                    alert('Error crítico al guardar');
                }
            }
        }
    }
</script>
{% endblock %}